ACTIVITIES = ["ups", "jog"]
DATA_PATH = "../../data"
SAVE_DIR_ROOT = "act_data"
CHECKPOINTS_DIR = "checkpoints"

# train:
#     input:
#         "config/{act}/data.yaml",
#         "config/{act}/train.yaml",
#         "train_on_activity.py"
#     output:
#         "checkpoint"
#     run:

# ~ train all
rule all:
    input:
        expand(f"{CHECKPOINTS_DIR}/{{act}}_checkpoint.ckpt", act=ACTIVITIES)

rule classify:
    input:
        config_classify_path = "config/classify.yaml",
        config_wandb_path = "config/wandb.yaml"
    shell:
        """
        python classify.py {input.config_classify_path} {input.config_wandb_path}
        """

rule train:
    input:
        "train_on_activity.py",
        f"{SAVE_DIR_ROOT}/{{act}}/dataset.pkl",
        config_train_path = "config/{act}/train.yaml",
        # for wandb config saving
        config_data_path = "config/{act}/data.yaml",
        config_wandb_path = "config/wandb.yaml"
    output:
        f"{CHECKPOINTS_DIR}/{{act}}_checkpoint.ckpt"
    shell:
        f"""
        python train_on_activity.py {{input.config_train_path}} {SAVE_DIR_ROOT}/{{wildcards.act}} {{input.config_data_path}} {{input.config_wandb_path}}
        """

rule make_dataset:
    input:
        "make_dataset.py",
        config_path = "config/{act}/data.yaml"
    output:
        f"{SAVE_DIR_ROOT}/{{act}}/dataset.pkl"
    shell:
        # need to remove auto created dirs before
        f"""
        rm -r {SAVE_DIR_ROOT}/{{wildcards.act}}; 
        python make_dataset.py {{input.config_path}} {DATA_PATH} {SAVE_DIR_ROOT}/{{wildcards.act}}
        """
